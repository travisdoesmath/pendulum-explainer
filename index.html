<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Chaotic Pendulums</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
    <div class="column">
        <h1>Building an n-tuple pendulum simulator from scratch</h1>
        <section id="caveat">
            <p>
                caveat: I am not a physicist, computer scientist, software engineer, or web developer. Once upon a time I knew some math, but now
                I am mostly just an intensely curious person. I've learned enough to make this work, and now I'd like to share it with you.
            </p>
        </section>
        <section id="overview-english">
            <h2>Overview (in plain English)</h2>
            <p>We will be building a simulator that runs on a webpage and animates the movement of an n-tuple pendulum.</p>
            <ul>
                <li>First, we will define the physical system that describes the motion of an n-tuple pendulum.</li>
                <li>Then we will create a JavaScript program that solves the equations of motion and animates a given n-tuple pendulum.</li>
                <li>Finally, we will speed up the simulation by moving the math out of JavaScript and into WebAssembly, using the Rust programming language.</li>
            </ul>
        </section>
        <section id="overview-technobabble">
            <h2>Overview (in techno-babble)</h2>
            <p>We will be building a simulator that runs on a webpage and animates the movement of an n-tuple pendulum.</p>
            <ul>
                <li>First, we will use a Lagrangian formulation to describe the equations of motion for an n-tuple pendulum. For ease of coding and solving, the equations of motion will be defined in a matrix equation \(Ax = b\).</li>
                <li>Then we will create a JavaScript program that uses a Runge-Kutta method (RK4) to numerically solve the system of differential equations obtained in step 1 and 
                    animate the simulation using the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/canvas">canvas element</a></li>
                <li>Finally, we will speed up the simulation by moving the RK4 solver out of JavaScript and into Rust, targeting WebAssembly</li>
            </ul>
        </section>
        <section id="but-why">
            <h2>But, why?</h2>
            <p>Great question! Regular, single pendulums are a simple physical system that can be solved analytically (I think). Probably very good for learning
                the basics of physical modeling and simulation, but pretty boring.
            </p>    
            <p>Double pendulums are also a reasonably simple physical system to describe, but they are an example of a <a href="https://en.wikipedia.org/wiki/Chaos_theory">chaotic system</a>. 
                Mathematically, this means that they show <a href="https://en.wikipedia.org/wiki/Butterfly_effect">sensitive dependence to initial conditions.</a>. Visually, this means they look hypnotically awesome.
                However, there are thousands of double pendulum simulators out there. 
            </p>
            <p>Triple pendulums have pretty gnarly equations of motion when you solve for them directly, and it's not <em>that</em> much more work to just solve for the general case and set
                \(n = 3\), so we might as well just do the little bit of extra work and figure out the general case.
            </p>
        </section>
        <section id="lets-go">
            <h2>Let's go!</h2>
        </section>
        <h2>Step 1: Equations of motion</h2>
        <p>
            To simulate the movement of some physical system, we want to be able to take any snapshot of time and predict where it will move next (and how fast). 
            For example, if we toss a ball into the air, after it leaves our hand, at any given snapshot of time, the ball has some position (where it is), velocity 
            (how fast it's going), and acceleration (how the velocity is changing). With that information, we can predict where the ball will be a short time after. 
            If the ball is 2 meters (6.56 feet) in the air and moving straight up at 1 meters per second (6.71 mph), then one tenth of a second later, it will be 
            approximately 2.1 meters (6.89 feet) in the air. We can get an even better approximation if we include the acceleration, but more on that later.
        </p>
        <p>
            For a given physical system, if we had a function that took in any given time value and spit out the positions of elements in the physical system, we'd be done!
            All we'd have to do then is draw the points of the physical system at their starting point, increase the time value a little bit, and then redraw the points of the 
            physical system at their new locations, and do that <a href="https://en.wikipedia.org/wiki/Persistence_of_vision">fast enough to make it look like it's moving</a>.           
        </p>
        <p>
            Unfortunately, we rarely have a function that just tells us the position at a given time. Instead, what we can do is figure out rules to describe what is happening for
            every possible snapshot of the physical system (that is, the position of all the points in the system, their velocity, and their acceleration), and use that to determine
            the next snapshot. One way of defining those rules is called <em><a href="https://en.wikipedia.org/wiki/Lagrangian_mechanics">Lagrangian mechanics</a></em>.
        </p>
        <h3>A little bit of math notation</h3>
        <p>
            It's about to get heavy with math formulas pretty soon, so before we jump into Lagrangian mechanics, so let's be clear about the notation we're using before moving 
            on. Also, we're going to be relying on quite a bit of calculus, so if you aren't familiar with calculus, the math section is going to make a lot of logical jumps that 
            probably won't make sense to you. If you want to go research calculus on your own, the topics we'll be using are the sum rule, the power rule, the product rule, the 
            chain rule, derivatives of sine and cosine, and partial derivatives.
        </p>
        <p>
            <ul>
                <li>
                    \(\sum_{i=1}^{n}[\ldots]\) is <a href="https://en.wikipedia.org/wiki/Summation#Capital-sigma_notation">capital-sigma notation</a> for summation. This says
                    to sum up whatever is in \([\ldots]\) where \(i\) counts up from \(1\) to \(n\). \(i\) is the <em>index</em> that we use to keep track of each object.
                </li>
                <li>
                    \(f(t)\) is a function that takes \(t\) as an input, and outputs some transformed value. We just use \(f(t)\) to refer to the output. Functions can be 
                    written with any name for their input variable (often \(x\)), but in this context, \(t\) almost always means time.
                </li>
                <li>
                    \(\frac{d}{dt}f(t)\) is the derivative of \(f(t)\) with respect to \(t\). Here, \(t\) means time.
                </li>
                <li>
                    \(\dot{f}\) (notice the little dot!) is another way of writing the derivative of \(f\) with respect to time. We often use this when talking about values that 
                    are dependent on time, but where writing them as functions would be cumbersome. 
                </li>
                <li>
                    \(\ddot{f}\) (notice the two little dots!) is the second derivative of \(f\) with respect to time.
                </li>
                <li>
                    \(\frac{\partial A}{\partial x}\) is the partial derivative of a multivariate function or expression \(A\) with respect to the variable \(x\)
                </li>
            </ul>
        </p>
        <h3>Lagrangian mechanics</h3>
        <p>
            In Lagrangian mechanics, we start with the difference of the kinetic energy (\(T\)) and the potential energy (\(V)\) of the physical system. This difference is called the
            <em>Lagrangian</em> (\(L = T - V\)). The kinetic energy of a system is defined as \(\frac{1}{2}\sum_{i=1}^{n}m_iv_i^2\) where \(m_i\) is the mass of each object (the \(i\) 
            is an index to keep track of each obect) and \(v_i^2\) is the squared magnitude of the velocity of each object. For pendulum systems, we're only going to worry
            about the gravitational potential energy. If two objects have the same mass, but one is higher up than the other, then the object that is higher up has more gravitational 
            potential energy. If two objects are at the same height, but one is more massive than the other, then the more massive object has more gravitational potential energy.
            We will represent this with the definition \(V = \sum_{i=1}^{n} gm_iy_i\) where \(g\) is the acceleration factor due to gravity, \(m_i\) is still the mass of each object, 
            and \(y_i\) is the y&#8209;position, or height, of each object.
        </p>
        <p>
            With the Lagrangian \(L\) defined, we use the following Euler-Lagrange equations to give us the equations of motion of the system:
            $$ \frac{d}{dt}\left(\frac{\partial L}{\partial \dot{q}_i}\right) = \frac{\partial L}{\partial q_i} $$
            where \(q_i\) represents some point in the system. Note: the Lagrangian may be defined in terms of abstract quantities in a 
            <a href="https://en.wikipedia.org/wiki/Phase_space">phase space</a> describing the system. For example, we will be using the phase space of angles and angular velocities
            in our formulation for the n-tuple pendulum.
        </p>
        <p>
            Now we are ready to describe the equations of motion for the n-tuple pendulum.
        </p>
        <h3>Lagrangian formulation of the n-tuple pendulum</h3>
        <figure>
            <svg width="475" height="425" alt='Diagram of n-tuple pendulum' id="diagram">
                <line x1="50" y1="0" x2="50", y2="425" stroke="#888" stroke-width="3"></line>
                <line x1="0" y1="50" x2="475", y2="50" stroke="#888" stroke-width="3"></line>
                <circle cx="50" cy="50" r="4" fill="#888"></circle>
            </svg>
            <figcaption>Diagram of coordinates of an n-tuple pendulum</figcaption>
        </figure>

        $$x_i = \sum_{j=1}^i\sin\theta_j, \quad y_i = -\sum_{j=1}^i\cos\theta_j$$
        $$\dot{x}_i = \sum_{j=1}^i\dot{\theta}_j\cos\theta_j, \quad \dot{y}_i = \sum_{j=1}^i\dot{\theta}_j\sin\theta_j$$
        $$g = -9.8$$
        <hr>
        $$ L = T - V $$
        <hr>
        $$\begin{eqnarray}
        T &=& \frac{1}{2}\sum_{i=1}^n m_i v_i^2 \\
          &=& \frac{1}{2}\sum_{i=1}^n(\dot{x}_i^2 + \dot{y}_i^2) \\
          &=& \frac{1}{2}\sum_{i=1}^n \left( \left[\sum_{j=1}^i\dot{\theta}_j\cos\theta_j\right]^2 + \left[ \sum_{j=1}^i\dot{\theta}_j\sin\theta_j \right]^2 \right) \\
          &=& \frac{1}{2}\sum_{i=1}^n \left(\sum_{j=1}^n\dot{\theta}_j^2 
            + \sum_{j \neq k}2\dot{\theta}_j\dot{\theta}_k\cos\theta_j\cos\theta_k 
            + \sum_{j \neq k}2\dot{\theta}_j\dot{\theta}_k\sin\theta_j\sin\theta_k\right) \\
          &=& \frac{1}{2}\sum_{i=1}^n \left(\sum_{j=1}^n\dot{\theta}_j^2 + \sum_{j \neq k}2\dot{\theta}_j\dot{\theta}_k\cos(\theta_j - \theta_k) \right) \\
          &=& \sum_{i=1}^n \left(\sum_{j=1}^n\frac{1}{2}\dot{\theta}_j^2 + \sum_{j \neq k}\dot{\theta}_j\dot{\theta}_k\cos(\theta_j - \theta_k) \right)
        \end{eqnarray}$$
        <hr>
        $$\begin{eqnarray}
        V &=& \sum_{i=1}^nm_igy_i \\
          &=& -g\sum_{i=1}^n\sum_{j=1}^i\cos\theta_j \\
          &=& -g\sum_{i=1}^n(n-i+1)\cos\theta_i \\
        \end{eqnarray}$$
        <hr>
        $$\begin{eqnarray}
        L &=& T - V = \sum_{i=1}^n \left(\sum_{j=1}^n\frac{1}{2}\dot{\theta}_j^2 + \sum_{j \neq k}\dot{\theta}_j\dot{\theta}_k\cos(\theta_j - \theta_k) \right) + g\sum_{i=1}^n(n-i+1)\cos\theta_i \\
        \end{eqnarray}$$
        <hr>
        $$\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\theta}_i}\right) - \frac{\partial L}{\partial \theta_i} = 0$$
        <hr>
        $$\frac{\partial L}{\partial \dot{\theta}_i} = \sum_{j=1}^{n}c(i,j)\dot{\theta}_j\cos(\theta_i - \theta_j), \quad 
        c(i, j) = n - \max(i, j) + 1 = \left\{
            \begin{array}{lll}
                (n - i + 1) & \mbox{if } j \lt i \\
                (n - i + 1) & \mbox{if } j = i \\
                (n - j + 1) & \mbox{if } j \gt i
            \end{array}
        \right.$$

        $$\frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\theta}_i}\right) = 
            \sum_{j=1}^{n}c(i,j)\left[\ddot{\theta}_j\cos(\theta_i - \theta_j) - \dot{\theta}_i\dot{\theta}_j\sin(\theta_i - \theta_j) - \dot{\theta}_j^2\sin(\theta_i - \theta_j) \right]
        $$
        <hr>
        $$\frac{\partial L}{\partial \theta_i} = g(n - i + 1)\sin\theta_i - \sum_{j=1}^nc(i,j)\dot{\theta}_i\dot{\theta}_j\sin(\theta_i - \theta_j)$$
        <hr>
        $$\begin{eqnarray}
        && \frac{d}{dt}\left(\frac{\partial L}{\partial \dot{\theta}_i}\right) - \frac{\partial L}{\partial \theta_i} = 0 \\
            &\implies& \sum_{j=1}^{n}c(i,j)\left[\ddot{\theta}_j\cos(\theta_i - \theta_j) - \dot{\theta}_i\dot{\theta}_j\sin(\theta_i - \theta_j) - \dot{\theta}_j^2\sin(\theta_i - \theta_j) \right]
            - (n - i + 1)g\dot{\theta}_i\sin\theta_i + \sum_{j=1}^nc(i,j)\dot{\theta}_i\dot{\theta}_j\sin(\theta_i - \theta_j) = 0 \\
            &\implies& \sum_{j=1}^{n}c(i,j)\left[\ddot{\theta}_j\cos(\theta_i - \theta_j) - \dot{\theta}_j^2\sin(\theta_i - \theta_j) \right] - (n - i + 1)g\dot{\theta}_i\sin\theta_i = 0 \\
            &\implies& \sum_{j=1}^{n}c(i,j)\ddot{\theta}_j\cos(\theta_i - \theta_j) = g(n - i + 1)\dot{\theta}_i\sin\theta_i + \sum_{j=1}^{n}c(i,j)\dot{\theta}_j^2\sin(\theta_i - \theta_j)
        \end{eqnarray}$$
    </div>
    <script src="main.js"></script>
</body>
</html>